# =============================================================================
# bac-py Docker Integration Tests
# =============================================================================
#
# Scenarios:
#   1. Client/Server       (profile: client-server)   — basic read/write/discover
#   2. BBMD                (profile: bbmd)             — foreign device forwarding
#   3. Router              (profile: router)           — cross-network routing
#   4. BIP Stress          (profile: stress)           — mixed-workload throughput
#   5. Demo Thermostat     (profile: demo)             — interactive demo
#   6. Device Management   (profile: device-mgmt)      — DCC, TimeSynchronization
#   7. COV Advanced        (profile: cov-advanced)     — subscriptions, lifetime
#   8. Events & Alarms     (profile: events)           — alarms, acknowledgement
#   9. Secure Connect      (profile: secure-connect)   — SC hub/node WebSocket
#  10. SC Stress           (profile: sc-stress)        — SC throughput/latency
#
# Runners (JSON report to stdout):
#   - BIP stress runner    (profile: stress-runner)
#   - SC stress runner     (profile: sc-stress-runner)
#
# Usage:
#   make docker-test              # run all test scenarios
#   make docker-test-client       # run scenario 1 only
#   make docker-stress            # run BIP stress runner (JSON output)
#   make docker-sc-stress         # run SC stress runner (JSON output)
#   make docker-clean             # remove all containers/images
# =============================================================================

networks:
  bacnet-main:
    driver: bridge
    ipam:
      config:
        - subnet: 172.30.1.0/24
  bacnet-secondary:
    driver: bridge
    ipam:
      config:
        - subnet: 172.30.2.0/24
  bacnet-foreign:
    driver: bridge
    ipam:
      config:
        - subnet: 172.30.3.0/24

# ---------------------------------------------------------------------------
# Shared anchors
# ---------------------------------------------------------------------------

x-healthcheck: &healthcheck
  healthcheck:
    test: ["CMD", "test", "-f", "/tmp/healthy"]
    interval: 2s
    timeout: 3s
    retries: 15
    start_period: 5s

x-build: &build
  build:
    context: ..
    dockerfile: docker/Dockerfile

services:

  # ===========================================================================
  # Scenario 1: Client/Server (basic read/write/discover)
  # ===========================================================================

  server1:
    <<: [*build, *healthcheck]
    container_name: bacnet-server1
    environment:
      ROLE: server
      DEVICE_INSTANCE: "100"
      BACNET_PORT: "47808"
      BROADCAST_ADDRESS: "172.30.1.255"
    networks:
      bacnet-main:
        ipv4_address: 172.30.1.10
    profiles: ["client-server", "all"]

  test-client-server:
    <<: *build
    container_name: bacnet-test-client-server
    environment:
      ROLE: test
      TEST_FILE: test_client_server.py
      SERVER_ADDRESS: "172.30.1.10"
      SERVER_INSTANCE: "100"
    networks:
      bacnet-main:
        ipv4_address: 172.30.1.20
    depends_on:
      server1:
        condition: service_healthy
    profiles: ["client-server", "all"]

  # ===========================================================================
  # Scenario 2: BBMD (foreign device registration + forwarding)
  # ===========================================================================

  bbmd1:
    <<: [*build, *healthcheck]
    container_name: bacnet-bbmd1
    environment:
      ROLE: bbmd
      DEVICE_INSTANCE: "200"
      BACNET_PORT: "47808"
      BROADCAST_ADDRESS: "172.30.1.255"
    networks:
      bacnet-main:
        ipv4_address: 172.30.1.30
    profiles: ["bbmd", "all"]

  server-on-bbmd-net:
    <<: [*build, *healthcheck]
    container_name: bacnet-server-bbmd
    environment:
      ROLE: server
      DEVICE_INSTANCE: "201"
      BACNET_PORT: "47808"
      BROADCAST_ADDRESS: "172.30.1.255"
    networks:
      bacnet-main:
        ipv4_address: 172.30.1.31
    profiles: ["bbmd", "all"]

  test-bbmd:
    <<: *build
    container_name: bacnet-test-bbmd
    environment:
      ROLE: test
      TEST_FILE: test_bbmd.py
      BBMD_ADDRESS: "172.30.1.30"
      SERVER_ADDRESS: "172.30.1.31"
      SERVER_INSTANCE: "201"
      BBMD_INSTANCE: "200"
    networks:
      bacnet-foreign:
        ipv4_address: 172.30.3.10
    profiles: ["bbmd", "all"]
    depends_on:
      bbmd1:
        condition: service_healthy
      server-on-bbmd-net:
        condition: service_healthy

  # ===========================================================================
  # Scenario 3: Router (cross-network communication)
  # ===========================================================================

  router1:
    <<: [*build, *healthcheck]
    container_name: bacnet-router1
    environment:
      ROLE: router
      DEVICE_INSTANCE: "300"
      NETWORK_1: "1"
      NETWORK_2: "2"
      INTERFACE_1: "172.30.1.50"
      INTERFACE_2: "172.30.2.50"
      PORT_1: "47808"
      PORT_2: "47808"
      BROADCAST_ADDRESS: "172.30.1.255"
    networks:
      bacnet-main:
        ipv4_address: 172.30.1.50
      bacnet-secondary:
        ipv4_address: 172.30.2.50
    profiles: ["router", "all"]

  server-net2:
    <<: [*build, *healthcheck]
    container_name: bacnet-server-net2
    environment:
      ROLE: server
      DEVICE_INSTANCE: "301"
      BACNET_PORT: "47808"
      BROADCAST_ADDRESS: "172.30.2.255"
    networks:
      bacnet-secondary:
        ipv4_address: 172.30.2.10
    profiles: ["router", "all"]

  test-router:
    <<: *build
    container_name: bacnet-test-router
    environment:
      ROLE: test
      TEST_FILE: test_router.py
      ROUTER_ADDRESS: "172.30.1.50"
      SERVER_NET2_ADDRESS: "172.30.2.10"
      SERVER_NET2_INSTANCE: "301"
      ROUTER_INSTANCE: "300"
      NETWORK_1: "1"
      NETWORK_2: "2"
    networks:
      bacnet-main:
        ipv4_address: 172.30.1.60
    depends_on:
      router1:
        condition: service_healthy
      server-net2:
        condition: service_healthy
    profiles: ["router", "all"]

  # ===========================================================================
  # Scenario 4: BIP Stress (mixed-workload throughput/latency)
  # ===========================================================================

  server-stress:
    <<: [*build, *healthcheck]
    container_name: bacnet-server-stress
    mem_limit: 2g
    environment:
      ROLE: stress-server
      DEVICE_INSTANCE: "400"
      BACNET_PORT: "47808"
      BROADCAST_ADDRESS: "172.30.1.255"
    networks:
      bacnet-main:
        ipv4_address: 172.30.1.70
    profiles: ["stress", "stress-runner", "all"]

  test-stress:
    <<: *build
    container_name: bacnet-test-stress
    mem_limit: 2g
    environment:
      ROLE: test
      TEST_FILE: test_stress.py
      SERVER_ADDRESS: "172.30.1.70"
      SERVER_INSTANCE: "400"
    networks:
      bacnet-main:
        ipv4_address: 172.30.1.80
    depends_on:
      server-stress:
        condition: service_healthy
    profiles: ["stress", "all"]

  stress-runner:
    <<: *build
    container_name: bacnet-stress-runner
    mem_limit: 2g
    environment:
      ROLE: stress
      SERVER_ADDRESS: "172.30.1.70"
      SERVER_INSTANCE: "400"
      NUM_POOLS: "1"
      READERS_PER_POOL: "2"
      WRITERS_PER_POOL: "1"
      RPM_PER_POOL: "1"
      WPM_PER_POOL: "1"
      OBJLIST_WORKERS: "1"
      COV_SUBSCRIBERS: "1"
      WARMUP_SECONDS: "15"
      SUSTAIN_SECONDS: "60"
    networks:
      bacnet-main:
        ipv4_address: 172.30.1.81
    depends_on:
      server-stress:
        condition: service_healthy
    profiles: ["stress-runner"]

  # ===========================================================================
  # Scenario 5: Demo Thermostat (interactive demo application)
  # ===========================================================================

  thermostat:
    <<: [*build, *healthcheck]
    container_name: bacnet-thermostat
    environment:
      ROLE: thermostat
      DEVICE_INSTANCE: "500"
      BACNET_PORT: "47808"
      BROADCAST_ADDRESS: "172.30.1.255"
    networks:
      bacnet-main:
        ipv4_address: 172.30.1.90
    profiles: ["demo"]

  demo-client:
    <<: *build
    container_name: bacnet-demo-client
    environment:
      ROLE: demo-client
      SERVER_ADDRESS: "172.30.1.90"
      SERVER_INSTANCE: "500"
    networks:
      bacnet-main:
        ipv4_address: 172.30.1.91
    depends_on:
      thermostat:
        condition: service_healthy
    profiles: ["demo"]

  # ===========================================================================
  # Scenario 6: Device Management (DCC, TimeSynchronization, CreateObject, etc.)
  # ===========================================================================

  server-device-mgmt:
    <<: [*build, *healthcheck]
    container_name: bacnet-server-device-mgmt
    environment:
      ROLE: server
      DEVICE_INSTANCE: "600"
      BACNET_PORT: "47808"
      BROADCAST_ADDRESS: "172.30.1.255"
    networks:
      bacnet-main:
        ipv4_address: 172.30.1.100
    profiles: ["device-mgmt", "all"]

  test-device-mgmt:
    <<: *build
    container_name: bacnet-test-device-mgmt
    environment:
      ROLE: test
      TEST_FILE: test_device_mgmt.py
      SERVER_ADDRESS: "172.30.1.100"
      SERVER_INSTANCE: "600"
    networks:
      bacnet-main:
        ipv4_address: 172.30.1.101
    depends_on:
      server-device-mgmt:
        condition: service_healthy
    profiles: ["device-mgmt", "all"]

  # ===========================================================================
  # Scenario 7: COV Advanced (subscriptions, lifetime, confirmed/unconfirmed)
  # ===========================================================================

  server-cov:
    <<: [*build, *healthcheck]
    container_name: bacnet-server-cov
    environment:
      ROLE: server
      DEVICE_INSTANCE: "601"
      BACNET_PORT: "47808"
      BROADCAST_ADDRESS: "172.30.1.255"
    networks:
      bacnet-main:
        ipv4_address: 172.30.1.102
    profiles: ["cov-advanced", "all"]

  test-cov-advanced:
    <<: *build
    container_name: bacnet-test-cov-advanced
    environment:
      ROLE: test
      TEST_FILE: test_cov_advanced.py
      SERVER_ADDRESS: "172.30.1.102"
      SERVER_INSTANCE: "601"
    networks:
      bacnet-main:
        ipv4_address: 172.30.1.103
    depends_on:
      server-cov:
        condition: service_healthy
    profiles: ["cov-advanced", "all"]

  # ===========================================================================
  # Scenario 8: Events & Alarms (GetAlarmSummary, GetEventInfo, Acknowledge)
  # ===========================================================================

  server-events:
    <<: [*build, *healthcheck]
    container_name: bacnet-server-events
    environment:
      ROLE: server-extended
      DEVICE_INSTANCE: "602"
      BACNET_PORT: "47808"
      BROADCAST_ADDRESS: "172.30.1.255"
    networks:
      bacnet-main:
        ipv4_address: 172.30.1.104
    profiles: ["events", "all"]

  test-events:
    <<: *build
    container_name: bacnet-test-events
    environment:
      ROLE: test
      TEST_FILE: test_events.py
      SERVER_ADDRESS: "172.30.1.104"
      SERVER_INSTANCE: "602"
    networks:
      bacnet-main:
        ipv4_address: 172.30.1.105
    depends_on:
      server-events:
        condition: service_healthy
    profiles: ["events", "all"]

  # ===========================================================================
  # Scenario 9: BACnet Secure Connect (SC hub + node WebSocket communication)
  # ===========================================================================

  sc-hub:
    <<: [*build, *healthcheck]
    container_name: bacnet-sc-hub
    environment:
      ROLE: sc-hub
      BIND_ADDRESS: "0.0.0.0"
      BIND_PORT: "4443"
    networks:
      bacnet-main:
        ipv4_address: 172.30.1.120
    profiles: ["secure-connect", "all"]

  sc-node1:
    <<: [*build, *healthcheck]
    container_name: bacnet-sc-node1
    environment:
      ROLE: sc-node
      HUB_URI: "ws://172.30.1.120:4443"
      VMAC: "02AA00000001"
      NODE_SWITCH_PORT: "4444"
    networks:
      bacnet-main:
        ipv4_address: 172.30.1.121
    depends_on:
      sc-hub:
        condition: service_healthy
    profiles: ["secure-connect", "all"]

  sc-node2:
    <<: [*build, *healthcheck]
    container_name: bacnet-sc-node2
    environment:
      ROLE: sc-node
      HUB_URI: "ws://172.30.1.120:4443"
      VMAC: "02AA00000002"
      NODE_SWITCH_PORT: "4445"
    networks:
      bacnet-main:
        ipv4_address: 172.30.1.122
    depends_on:
      sc-hub:
        condition: service_healthy
    profiles: ["secure-connect", "all"]

  test-secure-connect:
    <<: *build
    container_name: bacnet-test-secure-connect
    environment:
      ROLE: test
      TEST_FILE: test_secure_connect.py
      SC_HUB_ADDRESS: "172.30.1.120"
      SC_HUB_PORT: "4443"
      SC_NODE1_VMAC: "02AA00000001"
      SC_NODE2_VMAC: "02AA00000002"
    networks:
      bacnet-main:
        ipv4_address: 172.30.1.123
    depends_on:
      sc-node1:
        condition: service_healthy
      sc-node2:
        condition: service_healthy
    profiles: ["secure-connect", "all"]

  # ===========================================================================
  # Scenario 10: SC Stress (WebSocket hub/node throughput)
  # ===========================================================================

  sc-stress-hub:
    <<: [*build, *healthcheck]
    container_name: bacnet-sc-stress-hub
    mem_limit: 2g
    environment:
      ROLE: sc-hub
      BIND_ADDRESS: "0.0.0.0"
      BIND_PORT: "4443"
    networks:
      bacnet-main:
        ipv4_address: 172.30.1.130
    profiles: ["sc-stress", "sc-stress-runner"]

  sc-stress-node1:
    <<: [*build, *healthcheck]
    container_name: bacnet-sc-stress-node1
    mem_limit: 1g
    environment:
      ROLE: sc-node
      HUB_URI: "ws://172.30.1.130:4443"
      VMAC: "02BB00000001"
    networks:
      bacnet-main:
        ipv4_address: 172.30.1.131
    depends_on:
      sc-stress-hub:
        condition: service_healthy
    profiles: ["sc-stress", "sc-stress-runner"]

  sc-stress-node2:
    <<: [*build, *healthcheck]
    container_name: bacnet-sc-stress-node2
    mem_limit: 1g
    environment:
      ROLE: sc-node
      HUB_URI: "ws://172.30.1.130:4443"
      VMAC: "02BB00000002"
    networks:
      bacnet-main:
        ipv4_address: 172.30.1.132
    depends_on:
      sc-stress-hub:
        condition: service_healthy
    profiles: ["sc-stress", "sc-stress-runner"]

  test-sc-stress:
    <<: *build
    container_name: bacnet-test-sc-stress
    mem_limit: 2g
    environment:
      ROLE: test
      TEST_FILE: test_sc_stress.py
      SC_STRESS_HUB_ADDRESS: "172.30.1.130"
      SC_STRESS_HUB_PORT: "4443"
      SC_STRESS_NODE1_VMAC: "02BB00000001"
      SC_STRESS_NODE2_VMAC: "02BB00000002"
    networks:
      bacnet-main:
        ipv4_address: 172.30.1.133
    depends_on:
      sc-stress-node1:
        condition: service_healthy
      sc-stress-node2:
        condition: service_healthy
    profiles: ["sc-stress"]

  sc-stress-runner:
    <<: *build
    container_name: bacnet-sc-stress-runner
    mem_limit: 2g
    environment:
      ROLE: sc-stress
      SC_STRESS_HUB_URI: "ws://172.30.1.130:4443"
      SC_STRESS_NODE1_VMAC: "02BB00000001"
      SC_STRESS_NODE2_VMAC: "02BB00000002"
      UNICAST_WORKERS: "8"
      BROADCAST_WORKERS: "2"
      WARMUP_SECONDS: "15"
      SUSTAIN_SECONDS: "60"
    networks:
      bacnet-main:
        ipv4_address: 172.30.1.134
    depends_on:
      sc-stress-node1:
        condition: service_healthy
      sc-stress-node2:
        condition: service_healthy
    profiles: ["sc-stress-runner"]
