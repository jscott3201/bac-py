# =============================================================================
# bac-py Docker Integration Tests
# =============================================================================
#
# Scenarios:
#   1. Client/Server       (profile: client-server)   — basic read/write/discover
#   2. BBMD                (profile: bbmd)             — foreign device forwarding
#   3. Router              (profile: router)           — cross-network routing
#   4. BIP Stress          (profile: stress)           — mixed-workload throughput
#   5. Demo Thermostat     (profile: demo)             — interactive demo
#   6. Device Management   (profile: device-mgmt)      — DCC, TimeSynchronization
#   7. COV Advanced        (profile: cov-advanced)     — subscriptions, lifetime
#   8. Events & Alarms     (profile: events)           — alarms, acknowledgement
#   9. Secure Connect      (profile: secure-connect)   — SC hub/node WebSocket
#  10. SC Stress           (profile: sc-stress)        — SC throughput/latency
#  11. Router Stress       (profile: router-stress)    — cross-network routing
#  12. BBMD Stress         (profile: bbmd-stress)      — foreign device forwarding
#  13. IPv6 Client/Server  (profile: ipv6)             — BACnet/IPv6 (Annex U)
#  14. Mixed BIP↔IPv6      (profile: mixed-bip-ipv6)   — cross-transport routing
#  15. Mixed BIP↔SC        (profile: mixed-bip-sc)     — cross-transport routing
#
# Runners (JSON report to stdout):
#   - BIP stress runner    (profile: stress-runner)
#   - SC stress runner     (profile: sc-stress-runner)
#   - Router stress runner (profile: router-stress-runner)
#   - BBMD stress runner   (profile: bbmd-stress-runner)
#
# Mixed-environment SC profiling:
#   - SC bench hub         (profile: sc-bench-hub)      — hub in Docker
#   - SC bench client      (profile: sc-bench-client)   — nodes+runner in Docker
#
# Usage:
#   make docker-test              # run all test scenarios
#   make docker-test-client       # run scenario 1 only
#   make docker-stress            # run BIP stress runner (JSON output)
#   make docker-sc-stress         # run SC stress runner (JSON output)
#   make docker-clean             # remove all containers/images
# =============================================================================

volumes:
  sc-certs:
  sc-stress-certs:

networks:
  bacnet-main:
    driver: bridge
    ipam:
      config:
        - subnet: 172.30.1.0/24
  bacnet-secondary:
    driver: bridge
    ipam:
      config:
        - subnet: 172.30.2.0/24
  bacnet-foreign:
    driver: bridge
    ipam:
      config:
        - subnet: 172.30.3.0/24
  bacnet-ipv6:
    driver: bridge
    enable_ipv6: true
    ipam:
      config:
        - subnet: fd00:bac:1::/64

# ---------------------------------------------------------------------------
# Shared anchors
# ---------------------------------------------------------------------------

x-healthcheck: &healthcheck
  healthcheck:
    test: ["CMD", "test", "-f", "/tmp/healthy"]
    interval: 2s
    timeout: 3s
    retries: 15
    start_period: 5s

x-build: &build
  image: bac-py:${BAC_PY_VERSION:-latest}
  build:
    context: ..
    dockerfile: docker/Dockerfile

services:

  # ===========================================================================
  # Scenario 1: Client/Server (basic read/write/discover)
  # ===========================================================================

  server1:
    <<: [*build, *healthcheck]
    container_name: bacnet-server1
    environment:
      ROLE: server
      DEVICE_INSTANCE: "100"
      BACNET_PORT: "47808"
      BROADCAST_ADDRESS: "172.30.1.255"
    networks:
      bacnet-main:
        ipv4_address: 172.30.1.10
    profiles: ["client-server", "all"]

  test-client-server:
    <<: *build
    container_name: bacnet-test-client-server
    environment:
      ROLE: test
      TEST_FILE: test_client_server.py
      SERVER_ADDRESS: "172.30.1.10"
      SERVER_INSTANCE: "100"
    networks:
      bacnet-main:
        ipv4_address: 172.30.1.20
    depends_on:
      server1:
        condition: service_healthy
    profiles: ["client-server", "all"]

  # ===========================================================================
  # Scenario 2: BBMD (foreign device registration + forwarding)
  # ===========================================================================

  bbmd1:
    <<: [*build, *healthcheck]
    container_name: bacnet-bbmd1
    environment:
      ROLE: bbmd
      DEVICE_INSTANCE: "200"
      BACNET_PORT: "47808"
      BROADCAST_ADDRESS: "172.30.1.255"
    networks:
      bacnet-main:
        ipv4_address: 172.30.1.30
    profiles: ["bbmd", "all"]

  server-on-bbmd-net:
    <<: [*build, *healthcheck]
    container_name: bacnet-server-bbmd
    environment:
      ROLE: server
      DEVICE_INSTANCE: "201"
      BACNET_PORT: "47808"
      BROADCAST_ADDRESS: "172.30.1.255"
    networks:
      bacnet-main:
        ipv4_address: 172.30.1.31
    profiles: ["bbmd", "all"]

  test-bbmd:
    <<: *build
    container_name: bacnet-test-bbmd
    environment:
      ROLE: test
      TEST_FILE: test_bbmd.py
      BBMD_ADDRESS: "172.30.1.30"
      SERVER_ADDRESS: "172.30.1.31"
      SERVER_INSTANCE: "201"
      BBMD_INSTANCE: "200"
    networks:
      bacnet-foreign:
        ipv4_address: 172.30.3.10
    profiles: ["bbmd", "all"]
    depends_on:
      bbmd1:
        condition: service_healthy
      server-on-bbmd-net:
        condition: service_healthy

  # ===========================================================================
  # Scenario 3: Router (cross-network communication)
  # ===========================================================================

  router1:
    <<: [*build, *healthcheck]
    container_name: bacnet-router1
    environment:
      ROLE: router
      DEVICE_INSTANCE: "300"
      NETWORK_1: "1"
      NETWORK_2: "2"
      INTERFACE_1: "172.30.1.50"
      INTERFACE_2: "172.30.2.50"
      PORT_1: "47808"
      PORT_2: "47808"
      BROADCAST_ADDRESS_1: "172.30.1.255"
      BROADCAST_ADDRESS_2: "172.30.2.255"
    networks:
      bacnet-main:
        ipv4_address: 172.30.1.50
      bacnet-secondary:
        ipv4_address: 172.30.2.50
    profiles: ["router", "all"]

  server-net2:
    <<: [*build, *healthcheck]
    container_name: bacnet-server-net2
    environment:
      ROLE: server
      DEVICE_INSTANCE: "301"
      BACNET_PORT: "47808"
      BROADCAST_ADDRESS: "172.30.2.255"
    networks:
      bacnet-secondary:
        ipv4_address: 172.30.2.10
    profiles: ["router", "all"]

  test-router:
    <<: *build
    container_name: bacnet-test-router
    environment:
      ROLE: test
      TEST_FILE: test_router.py
      ROUTER_ADDRESS: "172.30.1.50"
      SERVER_NET2_ADDRESS: "172.30.2.10"
      SERVER_NET2_INSTANCE: "301"
      ROUTER_INSTANCE: "300"
      NETWORK_1: "1"
      NETWORK_2: "2"
    networks:
      bacnet-main:
        ipv4_address: 172.30.1.60
    depends_on:
      router1:
        condition: service_healthy
      server-net2:
        condition: service_healthy
    profiles: ["router", "all"]

  # ===========================================================================
  # Scenario 4: BIP Stress (mixed-workload throughput/latency)
  # ===========================================================================

  server-stress:
    <<: [*build, *healthcheck]
    container_name: bacnet-server-stress
    mem_limit: 2g
    environment:
      ROLE: stress-server
      DEVICE_INSTANCE: "400"
      BACNET_PORT: "47808"
      BROADCAST_ADDRESS: "172.30.1.255"
    networks:
      bacnet-main:
        ipv4_address: 172.30.1.70
    profiles: ["stress", "stress-runner", "all"]

  test-stress:
    <<: *build
    container_name: bacnet-test-stress
    mem_limit: 2g
    environment:
      ROLE: test
      TEST_FILE: test_stress.py
      SERVER_ADDRESS: "172.30.1.70"
      SERVER_INSTANCE: "400"
    networks:
      bacnet-main:
        ipv4_address: 172.30.1.80
    depends_on:
      server-stress:
        condition: service_healthy
    profiles: ["stress", "all"]

  stress-runner:
    <<: *build
    container_name: bacnet-stress-runner
    mem_limit: 2g
    environment:
      ROLE: stress
      SERVER_ADDRESS: "172.30.1.70"
      SERVER_INSTANCE: "400"
      NUM_POOLS: "1"
      READERS_PER_POOL: "2"
      WRITERS_PER_POOL: "1"
      RPM_PER_POOL: "1"
      WPM_PER_POOL: "1"
      OBJLIST_WORKERS: "1"
      COV_SUBSCRIBERS: "1"
      WARMUP_SECONDS: "15"
      SUSTAIN_SECONDS: "60"
    networks:
      bacnet-main:
        ipv4_address: 172.30.1.81
    depends_on:
      server-stress:
        condition: service_healthy
    profiles: ["stress-runner"]

  # ===========================================================================
  # Scenario 5: Demo Thermostat (interactive demo application)
  # ===========================================================================

  thermostat:
    <<: [*build, *healthcheck]
    container_name: bacnet-thermostat
    environment:
      ROLE: thermostat
      DEVICE_INSTANCE: "500"
      BACNET_PORT: "47808"
      BROADCAST_ADDRESS: "172.30.1.255"
    networks:
      bacnet-main:
        ipv4_address: 172.30.1.90
    profiles: ["demo"]

  demo-client:
    <<: *build
    container_name: bacnet-demo-client
    environment:
      ROLE: demo-client
      SERVER_ADDRESS: "172.30.1.90"
      SERVER_INSTANCE: "500"
    networks:
      bacnet-main:
        ipv4_address: 172.30.1.91
    depends_on:
      thermostat:
        condition: service_healthy
    profiles: ["demo"]

  # ===========================================================================
  # Scenario 6: Device Management (DCC, TimeSynchronization, CreateObject, etc.)
  # ===========================================================================

  server-device-mgmt:
    <<: [*build, *healthcheck]
    container_name: bacnet-server-device-mgmt
    environment:
      ROLE: server
      DEVICE_INSTANCE: "600"
      BACNET_PORT: "47808"
      BROADCAST_ADDRESS: "172.30.1.255"
    networks:
      bacnet-main:
        ipv4_address: 172.30.1.100
    profiles: ["device-mgmt", "all"]

  test-device-mgmt:
    <<: *build
    container_name: bacnet-test-device-mgmt
    environment:
      ROLE: test
      TEST_FILE: test_device_mgmt.py
      SERVER_ADDRESS: "172.30.1.100"
      SERVER_INSTANCE: "600"
    networks:
      bacnet-main:
        ipv4_address: 172.30.1.101
    depends_on:
      server-device-mgmt:
        condition: service_healthy
    profiles: ["device-mgmt", "all"]

  # ===========================================================================
  # Scenario 7: COV Advanced (subscriptions, lifetime, confirmed/unconfirmed)
  # ===========================================================================

  server-cov:
    <<: [*build, *healthcheck]
    container_name: bacnet-server-cov
    environment:
      ROLE: server
      DEVICE_INSTANCE: "601"
      BACNET_PORT: "47808"
      BROADCAST_ADDRESS: "172.30.1.255"
    networks:
      bacnet-main:
        ipv4_address: 172.30.1.102
    profiles: ["cov-advanced", "all"]

  test-cov-advanced:
    <<: *build
    container_name: bacnet-test-cov-advanced
    environment:
      ROLE: test
      TEST_FILE: test_cov_advanced.py
      SERVER_ADDRESS: "172.30.1.102"
      SERVER_INSTANCE: "601"
    networks:
      bacnet-main:
        ipv4_address: 172.30.1.103
    depends_on:
      server-cov:
        condition: service_healthy
    profiles: ["cov-advanced", "all"]

  # ===========================================================================
  # Scenario 8: Events & Alarms (GetAlarmSummary, GetEventInfo, Acknowledge)
  # ===========================================================================

  server-events:
    <<: [*build, *healthcheck]
    container_name: bacnet-server-events
    environment:
      ROLE: server-extended
      DEVICE_INSTANCE: "602"
      BACNET_PORT: "47808"
      BROADCAST_ADDRESS: "172.30.1.255"
    networks:
      bacnet-main:
        ipv4_address: 172.30.1.104
    profiles: ["events", "all"]

  test-events:
    <<: *build
    container_name: bacnet-test-events
    environment:
      ROLE: test
      TEST_FILE: test_events.py
      SERVER_ADDRESS: "172.30.1.104"
      SERVER_INSTANCE: "602"
    networks:
      bacnet-main:
        ipv4_address: 172.30.1.105
    depends_on:
      server-events:
        condition: service_healthy
    profiles: ["events", "all"]

  # ===========================================================================
  # Scenario 9: BACnet Secure Connect (SC hub + node WebSocket communication)
  # ===========================================================================

  sc-cert-gen:
    <<: *build
    container_name: bacnet-sc-cert-gen
    environment:
      ROLE: sc-cert-gen
      CERT_DIR: /certs
      CERT_NAMES: "hub,node1,node2,stress"
    volumes:
      - sc-certs:/certs
    profiles: ["secure-connect", "all"]

  sc-hub:
    <<: [*build, *healthcheck]
    container_name: bacnet-sc-hub
    environment:
      ROLE: sc-hub
      BIND_ADDRESS: "0.0.0.0"
      BIND_PORT: "4443"
      TLS_CERT_DIR: /certs
      TLS_CERT_NAME: hub
    volumes:
      - sc-certs:/certs:ro
    networks:
      bacnet-main:
        ipv4_address: 172.30.1.120
    depends_on:
      sc-cert-gen:
        condition: service_completed_successfully
    profiles: ["secure-connect", "all"]

  sc-node1:
    <<: [*build, *healthcheck]
    container_name: bacnet-sc-node1
    environment:
      ROLE: sc-node
      HUB_URI: "wss://172.30.1.120:4443"
      VMAC: "02AA00000001"
      NODE_SWITCH_PORT: "4444"
      TLS_CERT_DIR: /certs
      TLS_CERT_NAME: node1
    volumes:
      - sc-certs:/certs:ro
    networks:
      bacnet-main:
        ipv4_address: 172.30.1.121
    depends_on:
      sc-hub:
        condition: service_healthy
    profiles: ["secure-connect", "all"]

  sc-node2:
    <<: [*build, *healthcheck]
    container_name: bacnet-sc-node2
    environment:
      ROLE: sc-node
      HUB_URI: "wss://172.30.1.120:4443"
      VMAC: "02AA00000002"
      NODE_SWITCH_PORT: "4445"
      TLS_CERT_DIR: /certs
      TLS_CERT_NAME: node2
    volumes:
      - sc-certs:/certs:ro
    networks:
      bacnet-main:
        ipv4_address: 172.30.1.122
    depends_on:
      sc-hub:
        condition: service_healthy
    profiles: ["secure-connect", "all"]

  test-secure-connect:
    <<: *build
    container_name: bacnet-test-secure-connect
    environment:
      ROLE: test
      TEST_FILE: test_secure_connect.py
      SC_HUB_ADDRESS: "172.30.1.120"
      SC_HUB_PORT: "4443"
      SC_NODE1_VMAC: "02AA00000001"
      SC_NODE2_VMAC: "02AA00000002"
      TLS_CERT_DIR: /certs
      TLS_CERT_NAME: stress
    volumes:
      - sc-certs:/certs:ro
    networks:
      bacnet-main:
        ipv4_address: 172.30.1.123
    depends_on:
      sc-node1:
        condition: service_healthy
      sc-node2:
        condition: service_healthy
    profiles: ["secure-connect", "all"]

  # ===========================================================================
  # Scenario 10: SC Stress (WebSocket hub/node throughput)
  # ===========================================================================

  sc-stress-cert-gen:
    <<: *build
    container_name: bacnet-sc-stress-cert-gen
    environment:
      ROLE: sc-cert-gen
      CERT_DIR: /certs
      CERT_NAMES: "hub,node1,node2,stress"
    volumes:
      - sc-stress-certs:/certs
    profiles: ["sc-stress", "sc-stress-runner"]

  sc-stress-hub:
    <<: [*build, *healthcheck]
    container_name: bacnet-sc-stress-hub
    mem_limit: 2g
    environment:
      ROLE: sc-hub
      BIND_ADDRESS: "0.0.0.0"
      BIND_PORT: "4443"
      TLS_CERT_DIR: /certs
      TLS_CERT_NAME: hub
    volumes:
      - sc-stress-certs:/certs:ro
    networks:
      bacnet-main:
        ipv4_address: 172.30.1.130
    depends_on:
      sc-stress-cert-gen:
        condition: service_completed_successfully
    profiles: ["sc-stress", "sc-stress-runner"]

  sc-stress-node1:
    <<: [*build, *healthcheck]
    container_name: bacnet-sc-stress-node1
    mem_limit: 1g
    environment:
      ROLE: sc-node
      HUB_URI: "wss://172.30.1.130:4443"
      VMAC: "02BB00000001"
      TLS_CERT_DIR: /certs
      TLS_CERT_NAME: node1
    volumes:
      - sc-stress-certs:/certs:ro
    networks:
      bacnet-main:
        ipv4_address: 172.30.1.131
    depends_on:
      sc-stress-hub:
        condition: service_healthy
    profiles: ["sc-stress", "sc-stress-runner"]

  sc-stress-node2:
    <<: [*build, *healthcheck]
    container_name: bacnet-sc-stress-node2
    mem_limit: 1g
    environment:
      ROLE: sc-node
      HUB_URI: "wss://172.30.1.130:4443"
      VMAC: "02BB00000002"
      TLS_CERT_DIR: /certs
      TLS_CERT_NAME: node2
    volumes:
      - sc-stress-certs:/certs:ro
    networks:
      bacnet-main:
        ipv4_address: 172.30.1.132
    depends_on:
      sc-stress-hub:
        condition: service_healthy
    profiles: ["sc-stress", "sc-stress-runner"]

  test-sc-stress:
    <<: *build
    container_name: bacnet-test-sc-stress
    mem_limit: 2g
    environment:
      ROLE: test
      TEST_FILE: test_sc_stress.py
      SC_STRESS_HUB_ADDRESS: "172.30.1.130"
      SC_STRESS_HUB_PORT: "4443"
      SC_STRESS_NODE1_VMAC: "02BB00000001"
      SC_STRESS_NODE2_VMAC: "02BB00000002"
      TLS_CERT_DIR: /certs
      TLS_CERT_NAME: stress
    volumes:
      - sc-stress-certs:/certs:ro
    networks:
      bacnet-main:
        ipv4_address: 172.30.1.133
    depends_on:
      sc-stress-node1:
        condition: service_healthy
      sc-stress-node2:
        condition: service_healthy
    profiles: ["sc-stress"]

  sc-stress-runner:
    <<: *build
    container_name: bacnet-sc-stress-runner
    mem_limit: 2g
    environment:
      ROLE: sc-stress
      SC_STRESS_HUB_URI: "wss://172.30.1.130:4443"
      SC_STRESS_NODE1_VMAC: "02BB00000001"
      SC_STRESS_NODE2_VMAC: "02BB00000002"
      UNICAST_WORKERS: "8"
      BROADCAST_WORKERS: "2"
      WARMUP_SECONDS: "15"
      SUSTAIN_SECONDS: "60"
      TLS_CERT_DIR: /certs
      TLS_CERT_NAME: stress
    volumes:
      - sc-stress-certs:/certs:ro
    networks:
      bacnet-main:
        ipv4_address: 172.30.1.134
    depends_on:
      sc-stress-node1:
        condition: service_healthy
      sc-stress-node2:
        condition: service_healthy
    profiles: ["sc-stress-runner"]

  # ===========================================================================
  # Scenario 11: Router Stress (cross-network routing throughput)
  # ===========================================================================

  router-stress:
    <<: [*build, *healthcheck]
    container_name: bacnet-router-stress
    mem_limit: 2g
    environment:
      ROLE: router
      DEVICE_INSTANCE: "500"
      NETWORK_1: "1"
      NETWORK_2: "2"
      INTERFACE_1: "172.30.1.150"
      INTERFACE_2: "172.30.2.50"
      PORT_1: "47808"
      PORT_2: "47808"
      BROADCAST_ADDRESS_1: "172.30.1.255"
      BROADCAST_ADDRESS_2: "172.30.2.255"
    networks:
      bacnet-main:
        ipv4_address: 172.30.1.150
      bacnet-secondary:
        ipv4_address: 172.30.2.50
    profiles: ["router-stress", "router-stress-runner"]

  server-router-stress:
    <<: [*build, *healthcheck]
    container_name: bacnet-server-router-stress
    mem_limit: 2g
    environment:
      ROLE: stress-server
      DEVICE_INSTANCE: "501"
      BACNET_PORT: "47808"
      BROADCAST_ADDRESS: "172.30.2.255"
    networks:
      bacnet-secondary:
        ipv4_address: 172.30.2.60
    depends_on:
      router-stress:
        condition: service_healthy
    profiles: ["router-stress", "router-stress-runner"]

  test-router-stress:
    <<: *build
    container_name: bacnet-test-router-stress
    mem_limit: 2g
    environment:
      ROLE: test
      TEST_FILE: test_router_stress.py
      SERVER_INSTANCE: "501"
      REMOTE_NETWORK: "2"
      BROADCAST_ADDRESS: "172.30.1.255"
      ROUTER_ADDRESS: "172.30.1.150"
      SERVER_ADDRESS: "2:172.30.2.60"
    networks:
      bacnet-main:
        ipv4_address: 172.30.1.160
    depends_on:
      router-stress:
        condition: service_healthy
      server-router-stress:
        condition: service_healthy
    profiles: ["router-stress"]

  router-stress-runner:
    <<: *build
    container_name: bacnet-router-stress-runner
    mem_limit: 2g
    environment:
      ROLE: router-stress
      SERVER_INSTANCE: "501"
      REMOTE_NETWORK: "2"
      BROADCAST_ADDRESS: "172.30.1.255"
      ROUTER_ADDRESS: "172.30.1.150"
      SERVER_ADDRESS: "2:172.30.2.60"
      NUM_POOLS: "1"
      READERS_PER_POOL: "2"
      WRITERS_PER_POOL: "1"
      RPM_PER_POOL: "1"
      WPM_PER_POOL: "1"
      OBJLIST_WORKERS: "1"
      WARMUP_SECONDS: "15"
      SUSTAIN_SECONDS: "60"
    networks:
      bacnet-main:
        ipv4_address: 172.30.1.161
    depends_on:
      router-stress:
        condition: service_healthy
      server-router-stress:
        condition: service_healthy
    profiles: ["router-stress-runner"]

  # ===========================================================================
  # Scenario 12: BBMD Stress (foreign device management throughput)
  # ===========================================================================

  bbmd-stress:
    <<: [*build, *healthcheck]
    container_name: bacnet-bbmd-stress
    mem_limit: 2g
    environment:
      ROLE: bbmd
      DEVICE_INSTANCE: "550"
      BACNET_PORT: "47808"
      BROADCAST_ADDRESS: "172.30.1.255"
    networks:
      bacnet-main:
        ipv4_address: 172.30.1.170
    profiles: ["bbmd-stress", "bbmd-stress-runner"]

  server-bbmd-stress:
    <<: [*build, *healthcheck]
    container_name: bacnet-server-bbmd-stress
    mem_limit: 2g
    environment:
      ROLE: stress-server
      DEVICE_INSTANCE: "551"
      BACNET_PORT: "47808"
      BROADCAST_ADDRESS: "172.30.1.255"
    networks:
      bacnet-main:
        ipv4_address: 172.30.1.171
    depends_on:
      bbmd-stress:
        condition: service_healthy
    profiles: ["bbmd-stress", "bbmd-stress-runner"]

  test-bbmd-stress:
    <<: *build
    container_name: bacnet-test-bbmd-stress
    mem_limit: 2g
    environment:
      ROLE: test
      TEST_FILE: test_bbmd_stress.py
      BBMD_ADDRESS: "172.30.1.170"
      SERVER_ADDRESS: "172.30.1.171"
      SERVER_INSTANCE: "551"
    networks:
      bacnet-main:
        ipv4_address: 172.30.1.172
    depends_on:
      bbmd-stress:
        condition: service_healthy
      server-bbmd-stress:
        condition: service_healthy
    profiles: ["bbmd-stress"]

  bbmd-stress-runner:
    <<: *build
    container_name: bacnet-bbmd-stress-runner
    mem_limit: 2g
    environment:
      ROLE: bbmd-stress
      BBMD_ADDRESS: "172.30.1.170"
      SERVER_ADDRESS: "172.30.1.171"
      SERVER_INSTANCE: "551"
      NUM_POOLS: "1"
      READERS_PER_POOL: "2"
      WRITERS_PER_POOL: "1"
      RPM_PER_POOL: "1"
      WPM_PER_POOL: "1"
      OBJLIST_WORKERS: "1"
      FDT_WORKERS: "1"
      BDT_WORKERS: "1"
      WARMUP_SECONDS: "15"
      SUSTAIN_SECONDS: "60"
    networks:
      bacnet-main:
        ipv4_address: 172.30.1.173
    depends_on:
      bbmd-stress:
        condition: service_healthy
      server-bbmd-stress:
        condition: service_healthy
    profiles: ["bbmd-stress-runner"]

  # ===========================================================================
  # Mixed-environment SC profiling (hub in Docker OR client in Docker)
  # ===========================================================================

  # Hub in Docker for profiling local client (make bench-sc-profile-client)
  sc-bench-hub:
    <<: [*build, *healthcheck]
    container_name: bacnet-sc-bench-hub
    mem_limit: 2g
    ports: ["4443:4443"]
    volumes:
      - ${SC_BENCH_CERTS:-.sc-bench-certs}:/certs:ro
    environment:
      ROLE: sc-hub
      BIND_ADDRESS: "0.0.0.0"
      BIND_PORT: "4443"
      TLS_CERT_DIR: /certs
      TLS_CERT_NAME: hub
    networks:
      bacnet-main:
        ipv4_address: 172.30.1.140
    profiles: ["sc-bench-hub"]

  # Nodes + runner in Docker for profiling local hub (make bench-sc-profile-hub)
  sc-bench-node1:
    <<: [*build, *healthcheck]
    container_name: bacnet-sc-bench-node1
    mem_limit: 1g
    extra_hosts: ["host.docker.internal:host-gateway"]
    volumes:
      - ${SC_BENCH_CERTS:-.sc-bench-certs}:/certs:ro
    environment:
      ROLE: sc-node
      HUB_URI: "wss://host.docker.internal:4443"
      VMAC: "02BB00000001"
      TLS_CERT_DIR: /certs
      TLS_CERT_NAME: node1
    networks:
      bacnet-main:
        ipv4_address: 172.30.1.141
    profiles: ["sc-bench-client"]

  sc-bench-node2:
    <<: [*build, *healthcheck]
    container_name: bacnet-sc-bench-node2
    mem_limit: 1g
    extra_hosts: ["host.docker.internal:host-gateway"]
    volumes:
      - ${SC_BENCH_CERTS:-.sc-bench-certs}:/certs:ro
    environment:
      ROLE: sc-node
      HUB_URI: "wss://host.docker.internal:4443"
      VMAC: "02BB00000002"
      TLS_CERT_DIR: /certs
      TLS_CERT_NAME: node2
    networks:
      bacnet-main:
        ipv4_address: 172.30.1.142
    profiles: ["sc-bench-client"]

  sc-bench-runner:
    <<: *build
    container_name: bacnet-sc-bench-runner
    mem_limit: 2g
    extra_hosts: ["host.docker.internal:host-gateway"]
    volumes:
      - ${SC_BENCH_CERTS:-.sc-bench-certs}:/certs:ro
    environment:
      ROLE: sc-stress
      SC_STRESS_HUB_URI: "wss://host.docker.internal:4443"
      SC_STRESS_NODE1_VMAC: "02BB00000001"
      SC_STRESS_NODE2_VMAC: "02BB00000002"
      UNICAST_WORKERS: "8"
      BROADCAST_WORKERS: "2"
      WARMUP_SECONDS: "15"
      SUSTAIN_SECONDS: "60"
      TLS_CERT_DIR: /certs
      TLS_CERT_NAME: stress
    depends_on:
      sc-bench-node1: {condition: service_healthy}
      sc-bench-node2: {condition: service_healthy}
    networks:
      bacnet-main:
        ipv4_address: 172.30.1.143
    profiles: ["sc-bench-client"]

  # ===========================================================================
  # Scenario 13: IPv6 Client/Server (BACnet/IPv6 Annex U)
  # ===========================================================================

  server-ipv6:
    <<: [*build, *healthcheck]
    container_name: bacnet-server-ipv6
    environment:
      ROLE: server-ipv6
      DEVICE_INSTANCE: "700"
      BACNET_PORT: "47808"
      IPV6_INTERFACE: "::"
      IPV6_MULTICAST: "ff02::bac0"
    networks:
      bacnet-ipv6:
        ipv6_address: fd00:bac:1::10
    profiles: ["ipv6", "all"]

  test-ipv6:
    <<: *build
    container_name: bacnet-test-ipv6
    environment:
      ROLE: test
      TEST_FILE: test_ipv6_client_server.py
      SERVER_ADDRESS: "fd00:bac:1::10"
      SERVER_INSTANCE: "700"
    networks:
      bacnet-ipv6:
        ipv6_address: fd00:bac:1::20
    depends_on:
      server-ipv6:
        condition: service_healthy
    profiles: ["ipv6", "all"]

  # ===========================================================================
  # Scenario 14: Mixed BIP ↔ IPv6 (cross-transport routing)
  # ===========================================================================

  router-mixed-ipv6:
    <<: [*build, *healthcheck]
    container_name: bacnet-router-mixed-ipv6
    environment:
      ROLE: router
      DEVICE_INSTANCE: "800"
      NETWORK_1: "1"
      NETWORK_2: "2"
      INTERFACE_1: "172.30.1.180"
      INTERFACE_2: "fd00:bac:1::40"
      PORT_1: "47808"
      PORT_2: "47808"
      BROADCAST_ADDRESS_1: "172.30.1.255"
      IPV6_2: "true"
      MULTICAST_2: "ff02::bac0"
    networks:
      bacnet-main:
        ipv4_address: 172.30.1.180
      bacnet-ipv6:
        ipv6_address: fd00:bac:1::40
    profiles: ["mixed-bip-ipv6"]

  server-mixed-ipv6:
    <<: [*build, *healthcheck]
    container_name: bacnet-server-mixed-ipv6
    environment:
      ROLE: server-ipv6
      DEVICE_INSTANCE: "801"
      BACNET_PORT: "47808"
      IPV6_INTERFACE: "::"
      IPV6_MULTICAST: "ff02::bac0"
      IPV6_VMAC: "aabbcc"
    networks:
      bacnet-ipv6:
        ipv6_address: fd00:bac:1::30
    profiles: ["mixed-bip-ipv6"]

  test-mixed-bip-ipv6:
    <<: *build
    container_name: bacnet-test-mixed-bip-ipv6
    environment:
      ROLE: test
      TEST_FILE: test_mixed_bip_ipv6.py
      ROUTER_ADDRESS: "172.30.1.180"
      SERVER_INSTANCE: "801"
      SERVER_VMAC: "aabbcc"
      NETWORK_2: "2"
    networks:
      bacnet-main:
        ipv4_address: 172.30.1.182
    depends_on:
      router-mixed-ipv6:
        condition: service_healthy
      server-mixed-ipv6:
        condition: service_healthy
    profiles: ["mixed-bip-ipv6"]

  # ===========================================================================
  # Scenario 15: Mixed BIP ↔ SC (cross-transport NPDU routing)
  # ===========================================================================

  sc-mixed-hub:
    <<: [*build, *healthcheck]
    container_name: bacnet-sc-mixed-hub
    environment:
      ROLE: sc-hub
      BIND_ADDRESS: "0.0.0.0"
      BIND_PORT: "4443"
      TLS_CERT_DIR: /certs
      TLS_CERT_NAME: hub
    volumes:
      - ${SC_MIXED_CERTS:-.sc-mixed-certs}:/certs:ro
    networks:
      bacnet-main:
        ipv4_address: 172.30.1.190
    profiles: ["mixed-bip-sc"]

  sc-mixed-node1:
    <<: [*build, *healthcheck]
    container_name: bacnet-sc-mixed-node1
    environment:
      ROLE: sc-npdu-echo
      HUB_URI: "wss://172.30.1.190:4443"
      VMAC: "02CC00000001"
      TLS_CERT_DIR: /certs
      TLS_CERT_NAME: node1
    volumes:
      - ${SC_MIXED_CERTS:-.sc-mixed-certs}:/certs:ro
    networks:
      bacnet-main:
        ipv4_address: 172.30.1.191
    depends_on:
      sc-mixed-hub:
        condition: service_healthy
    profiles: ["mixed-bip-sc"]

  sc-mixed-node2:
    <<: [*build, *healthcheck]
    container_name: bacnet-sc-mixed-node2
    environment:
      ROLE: sc-npdu-echo
      HUB_URI: "wss://172.30.1.190:4443"
      VMAC: "02CC00000002"
      TLS_CERT_DIR: /certs
      TLS_CERT_NAME: node2
    volumes:
      - ${SC_MIXED_CERTS:-.sc-mixed-certs}:/certs:ro
    networks:
      bacnet-main:
        ipv4_address: 172.30.1.193
    depends_on:
      sc-mixed-hub:
        condition: service_healthy
    profiles: ["mixed-bip-sc"]

  router-bip-sc:
    <<: [*build, *healthcheck]
    container_name: bacnet-router-bip-sc
    environment:
      ROLE: router-bip-sc
      BIP_INTERFACE: "172.30.1.188"
      BIP_PORT: "47808"
      BIP_NETWORK: "1"
      BIP_BROADCAST: "172.30.1.255"
      SC_HUB_URI: "wss://172.30.1.190:4443"
      SC_NETWORK: "2"
      TLS_CERT_DIR: /certs
      TLS_CERT_NAME: router
    volumes:
      - ${SC_MIXED_CERTS:-.sc-mixed-certs}:/certs:ro
    networks:
      bacnet-main:
        ipv4_address: 172.30.1.188
    depends_on:
      sc-mixed-node1:
        condition: service_healthy
      sc-mixed-node2:
        condition: service_healthy
    profiles: ["mixed-bip-sc"]

  test-mixed-bip-sc:
    <<: *build
    container_name: bacnet-test-mixed-bip-sc
    environment:
      ROLE: test
      TEST_FILE: test_mixed_bip_sc.py
      ROUTER_ADDRESS: "172.30.1.188"
      ROUTER_PORT: "47808"
      SC_NETWORK: "2"
      SC_NODE1_VMAC: "02CC00000001"
      SC_NODE2_VMAC: "02CC00000002"
    networks:
      bacnet-main:
        ipv4_address: 172.30.1.192
    depends_on:
      router-bip-sc:
        condition: service_healthy
    profiles: ["mixed-bip-sc"]
